<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ˜æ–—ç³»ç»Ÿ - å‡¡äººä¿®ä»™ä¼ </title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#d4af37',
            secondary: '#b80000',
            accent: '#4dabf7',
            dark: '#0d1421'
          },
          fontFamily: {
            xianxia: ['"STKaiti"', '"KaiTi"', 'serif'],
            zhongwen: ['"STZhongsong"', '"SimSun"', 'serif']
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .xianxia-shadow {
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
      }
      .bg-blur {
        backdrop-filter: blur(10px);
      }
      .combat-action-btn {
        transition: all 0.2s ease;
      }
      .combat-action-btn:active {
        transform: scale(0.95);
      }
      .combat-action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .health-bar-enemy .progress-fill {
        background: linear-gradient(90deg, var(--secondary-color), #e63946);
      }
      .combat-log {
        max-height: 150px;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <!-- é¡µé¢èƒŒæ™¯ -->
  <div class="fixed inset-0 z-0 overflow-hidden">
    <div id="backgroundAnimation" class="absolute inset-0 bg-dark opacity-95"></div>
  </div>

  <div class="container mx-auto px-4 py-4 relative z-10">
    <!-- å¤´éƒ¨æ ‡é¢˜ -->
    <header class="header mb-4">
      <h1 class="text-3xl font-xianxia text-primary text-center">æˆ˜æ–—ç³»ç»Ÿ</h1>
      <p class="text-lg text-center text-gray-300 font-zhongwen">é’ç‰›é•‡å¦–æ´ - ç¬¬ä¸€å±‚</p>
    </header>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar mb-6">
      <a href="index.html" class="nav-item">é¦–é¡µ</a>
      <a href="character.html" class="nav-item">è§’è‰²</a>
      <a href="quest.html" class="nav-item">ä»»åŠ¡</a>
      <a href="battle.html" class="nav-item active">æˆ˜æ–—</a>
      <a href="market.html" class="nav-item">äº¤æ˜“</a>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="space-y-6">
      <!-- æˆ˜æ–—åŒºåŸŸ -->
      <section class="battle-area relative">
        <!-- æˆ˜æ–—èƒŒæ™¯ -->
        <div class="absolute inset-0 bg-cover bg-center opacity-40" style="background-image: url('assets/battle-bg-placeholder.png');"></div>
        
        <!-- æˆ˜æ–—èˆå° -->
        <div class="relative h-[500px] flex items-center justify-between px-8">
          <!-- ç©å®¶è§’è‰² -->
          <div class="player-character w-1/4 flex flex-col items-center">
            <!-- è§’è‰²å¤´åƒ -->
            <div class="relative mb-4">
              <div class="w-32 h-32 rounded-full border-4 border-primary overflow-hidden">
                <img src="assets/character-placeholder.png" alt="è§’è‰²" class="w-full h-full object-cover">
              </div>
              <!-- è§’è‰²åç§° -->
              <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-1 rounded-full border border-primary">
                <span class="text-primary font-xianxia">éŸ©ç«‹</span>
              </div>
              <!-- è§’è‰²å¢ƒç•Œ -->
              <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-1 rounded-full border border-accent">
                <span class="text-accent text-sm">ç»ƒæ°”æœŸä¹å±‚</span>
              </div>
            </div>
            
            <!-- è§’è‰²è¡€æ¡ -->
            <div class="w-48">
              <div class="flex justify-between mb-1 text-sm">
                <span class="text-gray-300">ç”Ÿå‘½</span>
                <span class="text-primary">1500/1500</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
              </div>
            </div>
            
            <!-- è§’è‰²æ³•åŠ›æ¡ -->
            <div class="w-48 mt-2">
              <div class="flex justify-between mb-1 text-sm">
                <span class="text-gray-300">æ³•åŠ›</span>
                <span class="text-accent">1200/1200</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 100%; background: linear-gradient(90deg, var(--accent-color), #3a86ff);"></div>
              </div>
            </div>
          </div>

          <!-- æ•Œäººè§’è‰² -->
          <div class="enemy-character w-1/4 flex flex-col items-center">
            <!-- æ•Œäººå¤´åƒ -->
            <div class="relative mb-4">
              <div class="w-36 h-36 rounded-full border-4 border-secondary overflow-hidden">
                <img src="assets/enemy-placeholder.png" alt="æ•Œäºº" class="w-full h-full object-cover">
              </div>
              <!-- æ•Œäººåç§° -->
              <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-1 rounded-full border border-secondary">
                <span class="text-secondary font-xianxia">é’ç‰›å¦–</span>
              </div>
              <!-- æ•Œäººç­‰çº§ -->
              <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-dark/80 px-3 py-1 rounded-full border border-secondary">
                <span class="text-secondary text-sm">ç»ƒæ°”æœŸä¸ƒå±‚</span>
              </div>
            </div>
            
            <!-- æ•Œäººè¡€æ¡ -->
            <div class="w-48">
              <div class="flex justify-between mb-1 text-sm">
                <span class="text-gray-300">ç”Ÿå‘½</span>
                <span class="text-secondary">2000/2000</span>
              </div>
              <div class="progress-bar health-bar-enemy">
                <div class="progress-fill" style="width: 100%"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- æˆ˜æ–—æ“ä½œåŒº -->
      <section class="bg-panel p-6 rounded-lg border-2 border-primary xianxia-shadow">
        <h3 class="text-xl font-xianxia text-primary mb-4">æˆ˜æ–—æ“ä½œ</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- æŠ€èƒ½åŒº -->
          <div class="md:col-span-2">
            <h4 class="text-lg font-xianxia text-accent mb-3">æŠ€èƒ½</h4>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              <button class="combat-action-btn bg-dark/70 p-4 rounded-lg border border-primary hover:border-accent transition-all flex flex-col items-center">
                <span class="text-2xl mb-2">âš¡</span>
                <span class="text-gray-300 text-sm">é›·çµæœ¯</span>
                <span class="text-accent text-xs">80æ³•åŠ›</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-4 rounded-lg border border-primary hover:border-accent transition-all flex flex-col items-center">
                <span class="text-2xl mb-2">ğŸ”¥</span>
                <span class="text-gray-300 text-sm">ç«çƒæœ¯</span>
                <span class="text-accent text-xs">60æ³•åŠ›</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-4 rounded-lg border border-primary hover:border-accent transition-all flex flex-col items-center">
                <span class="text-2xl mb-2">ğŸ’§</span>
                <span class="text-gray-300 text-sm">æ°´å¹•å¤©å</span>
                <span class="text-accent text-xs">50æ³•åŠ›</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-4 rounded-lg border border-primary hover:border-accent transition-all flex flex-col items-center">
                <span class="text-2xl mb-2">ğŸŒªï¸</span>
                <span class="text-gray-300 text-sm">é£åˆƒæœ¯</span>
                <span class="text-accent text-xs">70æ³•åŠ›</span>
              </button>
            </div>
          </div>

          <!-- ç‰©å“ä¸é€ƒè·‘ -->
          <div>
            <h4 class="text-lg font-xianxia text-accent mb-3">å…¶ä»–æ“ä½œ</h4>
            <div class="grid grid-cols-2 gap-3">
              <button class="combat-action-btn bg-dark/70 p-3 rounded-lg border border-accent hover:bg-accent/20 transition-all flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸ’Š</span>
                <span class="text-gray-300 text-sm">ä½¿ç”¨è¯å“</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-3 rounded-lg border border-accent hover:bg-accent/20 transition-all flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸ’</span>
                <span class="text-gray-300 text-sm">æ‰“å¼€èƒŒåŒ…</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-3 rounded-lg border border-accent hover:bg-accent/20 transition-all flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸ›¡ï¸</span>
                <span class="text-gray-300 text-sm">é˜²å¾¡</span>
              </button>
              
              <button class="combat-action-btn bg-dark/70 p-3 rounded-lg border border-secondary hover:bg-secondary/20 transition-all flex flex-col items-center">
                <span class="text-2xl mb-1">ğŸƒ</span>
                <span class="text-gray-300 text-sm">é€ƒè·‘</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- æˆ˜æ–—ä¿¡æ¯ä¸æ—¥å¿— -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- æˆ˜æ–—ä¿¡æ¯ -->
        <div class="bg-panel p-6 rounded-lg border-2 border-primary xianxia-shadow">
          <h3 class="text-xl font-xianxia text-primary mb-4">æˆ˜æ–—ä¿¡æ¯</h3>
          
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-300">å½“å‰å›åˆ:</span>
              <span class="text-primary">ç¬¬ 1 å›åˆ</span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-gray-300">æˆ˜æ–—çŠ¶æ€:</span>
              <span class="text-accent">è¿›è¡Œä¸­</span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-gray-300">æ•Œæ–¹æ•°é‡:</span>
              <span class="text-primary">1 ä¸ª</span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-gray-300">èƒœåˆ©æ¡ä»¶:</span>
              <span class="text-primary">å‡»è´¥æ‰€æœ‰æ•Œäºº</span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-gray-300">å¤±è´¥æ¡ä»¶:</span>
              <span class="text-secondary">è§’è‰²æ­»äº¡</span>
            </div>
          </div>
        </div>

        <!-- æˆ˜æ–—æ—¥å¿— -->
        <div class="bg-panel p-6 rounded-lg border-2 border-primary xianxia-shadow">
          <h3 class="text-xl font-xianxia text-primary mb-4">æˆ˜æ–—æ—¥å¿—</h3>
          
          <div class="combat-log space-y-2 bg-dark/50 p-3 rounded-lg border border-gray-700">
            <div class="text-gray-300 text-sm">æˆ˜æ–—å¼€å§‹ï¼</div>
            <div class="text-gray-400 text-sm">ä½ é‡åˆ°äº†ä¸€åªé’ç‰›å¦–ï¼</div>
            <div class="text-gray-400 text-sm">é’ç‰›å¦–æ­£æ€’è§†ç€ä½ ï¼Œå‡†å¤‡å‘èµ·æ”»å‡»...</div>
          </div>
        </div>
      </section>

      <!-- æˆ˜æ–—å¥–åŠ±é¢„è§ˆ -->
      <section class="bg-panel p-6 rounded-lg border-2 border-primary xianxia-shadow">
        <h3 class="text-xl font-xianxia text-primary mb-4">èƒœåˆ©å¥–åŠ±é¢„è§ˆ</h3>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
          <div class="bg-dark/70 p-3 rounded-lg border border-primary/30 aspect-square flex flex-col items-center justify-center text-center hover:border-primary transition-all">
            <span class="text-2xl mb-1">ğŸ’°</span>
            <p class="text-xs text-gray-300">ä¸‹å“çµçŸ³</p>
            <p class="text-xs text-primary">x50</p>
          </div>
          
          <div class="bg-dark/70 p-3 rounded-lg border border-primary/30 aspect-square flex flex-col items-center justify-center text-center hover:border-primary transition-all">
            <span class="text-2xl mb-1">ğŸ’Š</span>
            <p class="text-xs text-gray-300">èšæ°”ä¸¹</p>
            <p class="text-xs text-primary">x2</p>
          </div>
          
          <div class="bg-dark/70 p-3 rounded-lg border border-primary/30 aspect-square flex flex-col items-center justify-center text-center hover:border-primary transition-all">
            <span class="text-2xl mb-1">ğŸª¨</span>
            <p class="text-xs text-gray-300">ç„é“</p>
            <p class="text-xs text-primary">x3</p>
          </div>
          
          <div class="bg-dark/70 p-3 rounded-lg border border-primary/30 aspect-square flex flex-col items-center justify-center text-center hover:border-primary transition-all">
            <span class="text-2xl mb-1">ğŸ“œ</span>
            <p class="text-xs text-gray-300">ä½é˜¶å¦–ä¸¹</p>
            <p class="text-xs text-primary">x1</p>
          </div>
          
          <div class="bg-dark/50 p-3 rounded-lg border border-gray-700 aspect-square flex flex-col items-center justify-center text-center">
            <span class="text-xl mb-1 text-gray-500">â“</span>
            <p class="text-xs text-gray-500">éšæœºå¥–åŠ±</p>
          </div>
        </div>
      </section>
    </main>

    <!-- é¡µè„š -->
    <footer class="mt-10 footer">
      <p>Â© 2023 å‡¡äººä¿®ä»™ä¼ ç½‘é¡µRPGæ¸¸æˆ - ä½“éªŒçœŸå®çš„ä¿®ä»™ä¸–ç•Œ</p>
    </footer>
  </div>

  <!-- è„šæœ¬ -->
  <script src="game.js"></script>
  <script>
    // æˆ˜æ–—ç³»ç»Ÿç›¸å…³é€»è¾‘
    document.addEventListener('DOMContentLoaded', () => {
      // å°è¯•è·å–è§’è‰²ç®¡ç†å™¨å’Œæˆ˜æ–—ç®¡ç†å™¨
      let characterManager;
      let battleManager;
      
      try {
        characterManager = window.require ? window.require('characterManager') : null;
        battleManager = window.require ? window.require('battleManager') : null;
        
        // å¦‚æœæœ‰è§’è‰²ç®¡ç†å™¨ï¼Œåˆ™ä½¿ç”¨è§’è‰²çš„å®é™…å±æ€§
        if (characterManager) {
          const playerData = characterManager.getPlayerCharacter();
          console.log('ç©å®¶è§’è‰²æ•°æ®:', playerData);
          
          // åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿ
          initBattleSystem(playerData);
        } else {
          // æ²¡æœ‰è§’è‰²ç®¡ç†å™¨æ—¶ä½¿ç”¨é»˜è®¤å€¼
          initBattleSystemWithDefaults();
        }
      } catch (e) {
        console.log('æˆ˜æ–—ç³»ç»Ÿæ¨¡å—åŠ è½½ä¸­...', e);
        initBattleSystemWithDefaults();
      }
      
      // æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const skillButtons = document.querySelectorAll('.combat-action-btn:not(.disabled)');
      let currentRound = 1;
      let playerHealth = 1500;
      let playerMana = 1200;
      let enemyHealth = 2000;
      let playerData = { name: 'éŸ©ç«‹', level: 5, cultivation: 'ç»ƒæ°”æœŸäº”å±‚' };
      
      // æ›´æ–°æˆ˜æ–—ä¿¡æ¯
      function updateBattleInfo() {
        document.querySelector('.text-primary:contains("ç¬¬")').textContent = `ç¬¬ ${currentRound} å›åˆ`;
        
        // æ›´æ–°è§’è‰²è¡€æ¡å’Œæ³•åŠ›æ¡
        const playerHealthBar = document.querySelector('.player-character .progress-bar:first-child .progress-fill');
        const playerManaBar = document.querySelector('.player-character .progress-bar:last-child .progress-fill');
        const enemyHealthBar = document.querySelector('.enemy-character .progress-bar .progress-fill');
        
        playerHealthBar.style.width = `${(playerHealth / 1500) * 100}%`;
        playerManaBar.style.width = `${(playerMana / 1200) * 100}%`;
        enemyHealthBar.style.width = `${(enemyHealth / 2000) * 100}%`;
        
        // æ›´æ–°æ•°å€¼æ˜¾ç¤º
        playerHealthBar.parentNode.previousElementSibling.querySelector('.text-primary').textContent = `${playerHealth}/1500`;
        playerManaBar.parentNode.previousElementSibling.querySelector('.text-accent').textContent = `${playerMana}/1200`;
        enemyHealthBar.parentNode.previousElementSibling.querySelector('.text-secondary').textContent = `${enemyHealth}/2000`;
      }
      
      // æ·»åŠ æˆ˜æ–—æ—¥å¿—
      function addBattleLog(message, isPlayer = false) {
        const logContainer = document.querySelector('.combat-log');
        const logEntry = document.createElement('div');
        logEntry.className = `text-sm ${isPlayer ? 'text-primary' : 'text-gray-300'}`;
        logEntry.textContent = message;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      // å¤„ç†æˆ˜æ–—ç»“æœ
      function checkBattleResult() {
        if (enemyHealth <= 0) {
          addBattleLog('æˆ˜æ–—èƒœåˆ©ï¼', true);
          
          // å¤„ç†æˆ˜æ–—å¥–åŠ±
          const rewards = handleBattleRewards();
          
          setTimeout(() => {
            // æ˜¾ç¤ºå¥–åŠ±æ‘˜è¦
            if (rewards && rewards.length > 0) {
              const rewardSummary = rewards.map(r => `${r.name} x${r.count}`).join('\n');
              if (typeof showNotification === 'function') {
                showNotification(`æˆ˜æ–—èƒœåˆ©ï¼\nè·å¾—å¥–åŠ±ï¼š\n${rewardSummary}`, 'success');
              } else {
                alert(`æˆ˜æ–—èƒœåˆ©ï¼è·å¾—å¥–åŠ±ï¼š\n${rewardSummary}`);
              }
            }
            
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šå¤„ç†å¥–åŠ±å‘æ”¾å’Œè¿”å›ä¸Šä¸€ä¸ªé¡µé¢
            // window.location.href = 'quest.html';
          }, 1000);
          return true;
        }
        
        if (playerHealth <= 0) {
          addBattleLog('æˆ˜æ–—å¤±è´¥ï¼', true);
          setTimeout(() => {
            if (typeof showNotification === 'function') {
              showNotification('æˆ˜æ–—å¤±è´¥ï¼ä½ éœ€è¦æ¢å¤ä¼¤åŠ¿åå†æ¬¡æŒ‘æˆ˜ã€‚', 'error');
            } else {
              alert('æˆ˜æ–—å¤±è´¥ï¼ä½ éœ€è¦æ¢å¤ä¼¤åŠ¿åå†æ¬¡æŒ‘æˆ˜ã€‚');
            }
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šå¤„ç†å¤±è´¥é€»è¾‘
            // window.location.href = 'character.html';
          }, 1000);
          return true;
        }
        
        return false;
      }
      
      // æ•Œäººå›åˆ
      function enemyTurn() {
        // éšæœºæ•Œäººæ”»å‡»
        const enemyAttack = Math.floor(Math.random() * 100) + 50;
        playerHealth = Math.max(0, playerHealth - enemyAttack);
        
        addBattleLog(`é’ç‰›å¦–å¯¹ä½ é€ æˆäº† ${enemyAttack} ç‚¹ä¼¤å®³ï¼`);
        updateBattleInfo();
        
        // æ£€æŸ¥æˆ˜æ–—ç»“æœ
        if (!checkBattleResult()) {
          // è¿›å…¥ä¸‹ä¸€å›åˆ
          currentRound++;
          updateBattleInfo();
          addBattleLog(`ç¬¬ ${currentRound} å›åˆå¼€å§‹ï¼`);
        }
      }
      
      // ç»‘å®šæŠ€èƒ½æŒ‰é’®äº‹ä»¶
      skillButtons.forEach(button => {
        button.addEventListener('click', () => {
          // è·å–æŠ€èƒ½ä¿¡æ¯
          const skillName = button.querySelector('.text-gray-300')?.textContent;
          const skillManaCost = button.querySelector('.text-accent')?.textContent;
          
          if (skillName === 'é€ƒè·‘') {
            // é€ƒè·‘é€»è¾‘
            const successRate = 0.3; // 30%æˆåŠŸç‡
            if (Math.random() < successRate) {
              addBattleLog('ä½ æˆåŠŸé€ƒè·‘äº†ï¼', true);
              setTimeout(() => {
                alert('ä½ æˆåŠŸé€ƒç¦»äº†æˆ˜æ–—ï¼');
                // window.location.href = 'quest.html';
              }, 1000);
            } else {
              addBattleLog('é€ƒè·‘å¤±è´¥ï¼', true);
              // è¿›å…¥æ•Œäººå›åˆ
              setTimeout(enemyTurn, 1000);
            }
            return;
          }
          
          if (skillName === 'é˜²å¾¡') {
            addBattleLog('ä½ è¿›å…¥äº†é˜²å¾¡çŠ¶æ€ï¼', true);
            // é˜²å¾¡é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œå®ç°
            // è¿›å…¥æ•Œäººå›åˆ
            setTimeout(enemyTurn, 1000);
            return;
          }
          
          if (skillName === 'ä½¿ç”¨è¯å“') {
            addBattleLog('ä½ ä½¿ç”¨äº†èšæ°”ä¸¹ï¼Œæ¢å¤äº†200ç‚¹ç”Ÿå‘½å€¼ï¼', true);
            playerHealth = Math.min(1500, playerHealth + 200);
            updateBattleInfo();
            // è¿›å…¥æ•Œäººå›åˆ
            setTimeout(enemyTurn, 1000);
            return;
          }
          
          if (skillName === 'æ‰“å¼€èƒŒåŒ…') {
            alert('èƒŒåŒ…åŠŸèƒ½å¾…å®ç°');
            return;
          }
          
          // å¤„ç†æŠ€èƒ½æ¶ˆè€—
          if (skillManaCost) {
            const manaCost = parseInt(skillManaCost);
            if (playerMana < manaCost) {
              addBattleLog('æ³•åŠ›ä¸è¶³ï¼', true);
              return;
            }
            playerMana -= manaCost;
          }
          
          // æ¨¡æ‹ŸæŠ€èƒ½æ•ˆæœ
          const damage = Math.floor(Math.random() * 100) + 100;
          enemyHealth = Math.max(0, enemyHealth - damage);
          
          addBattleLog(`ä½ ä½¿ç”¨äº†${skillName}ï¼Œå¯¹é’ç‰›å¦–é€ æˆäº† ${damage} ç‚¹ä¼¤å®³ï¼`, true);
          updateBattleInfo();
          
          // æ£€æŸ¥æˆ˜æ–—ç»“æœ
          if (!checkBattleResult()) {
            // è¿›å…¥æ•Œäººå›åˆ
            setTimeout(enemyTurn, 1000);
          }
        });
      });
    });

    // ä½¿ç”¨è§’è‰²æ•°æ®åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿ
    function initBattleSystem(playerData) {
      if (!playerData) return;
      
      // æ›´æ–°ç©å®¶æ•°æ®
      this.playerData = playerData;
      
      // æ›´æ–°æˆ˜æ–—ç•Œé¢æ˜¾ç¤ºçš„ç©å®¶ä¿¡æ¯
      document.querySelector('.player-character h3').textContent = playerData.name || 'éŸ©ç«‹';
      document.querySelector('.player-character p').textContent = playerData.cultivation || 'ç»ƒæ°”æœŸäº”å±‚';
      
      // ä½¿ç”¨è§’è‰²çš„å®é™…å±æ€§
      playerHealth = playerData.health || 1500;
      playerMana = playerData.mana || 1200;
      
      // å¦‚æœæœ‰æˆ˜æ–—ç®¡ç†å™¨ï¼Œå¯ä»¥åˆå§‹åŒ–æˆ˜æ–—çŠ¶æ€
      if (battleManager) {
        battleManager.initBattle(playerData, getEnemyData());
      }
      
      // æ˜¾ç¤ºåˆå§‹åŒ–é€šçŸ¥
      if (typeof showNotification === 'function') {
        showNotification(`æˆ˜æ–—å¼€å§‹ï¼${playerData.name}å¯¹é˜µé’ç‰›å¦–`, 'info');
      }
      
      // æ›´æ–°æˆ˜æ–—ä¿¡æ¯æ˜¾ç¤º
      updateBattleInfo();
    }

    // ä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿ
    function initBattleSystemWithDefaults() {
      // ä½¿ç”¨é»˜è®¤çš„ç©å®¶æ•°æ®
      const defaultPlayerData = {
        name: 'éŸ©ç«‹',
        level: 5,
        cultivation: 'ç»ƒæ°”æœŸäº”å±‚',
        health: 1500,
        mana: 1200,
        attack: 200,
        defense: 80
      };
      
      initBattleSystem(defaultPlayerData);
    }

    // è·å–æ•Œäººæ•°æ®
    function getEnemyData() {
      // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œå¯èƒ½ä¼šä»æœåŠ¡å™¨æˆ–é…ç½®æ–‡ä»¶è·å–æ•Œäººæ•°æ®
      return {
        name: 'é’ç‰›å¦–',
        level: 6,
        health: 2000,
        attack: 150,
        defense: 60,
        skills: ['é‡è›®å†²æ’', 'å¦–åŠ›å†²å‡»', 'å—œè¡€']
      };
    }

    // å¤„ç†æˆ˜æ–—å¥–åŠ±
    function handleBattleRewards() {
      if (!battleManager) {
        // ä½¿ç”¨æ¨¡æ‹Ÿçš„å¥–åŠ±æ•°æ®
        const rewards = [
          { name: 'ä¸‹å“çµçŸ³', count: 50 },
          { name: 'èšæ°”ä¸¹', count: 3 },
          { name: 'é’ç‰›å¦–è§’', count: 1 }
        ];
        
        // æ˜¾ç¤ºå¥–åŠ±é€šçŸ¥
        if (typeof showNotification === 'function') {
          showNotification(`æˆ˜æ–—èƒœåˆ©ï¼è·å¾—å¥–åŠ±ï¼š${rewards.map(r => `${r.name} x${r.count}`).join(', ')}`, 'success');
        }
        
        // å¦‚æœæœ‰ç‰©å“ç®¡ç†å™¨ï¼Œå¯ä»¥æ·»åŠ å¥–åŠ±ç‰©å“
        try {
          const itemManager = window.require ? window.require('itemManager') : null;
          if (itemManager) {
            rewards.forEach(reward => {
              itemManager.addItem(reward.name, reward.count);
            });
          }
        } catch (e) {
          console.log('ç‰©å“ç³»ç»Ÿæ¨¡å—åŠ è½½ä¸­...');
        }
        
        // å¦‚æœæœ‰è§’è‰²ç®¡ç†å™¨ï¼Œå¯ä»¥å¢åŠ ç»éªŒå€¼
        if (characterManager) {
          characterManager.addExperience(500);
        }
        
        return rewards;
      }
      
      // ä½¿ç”¨æˆ˜æ–—ç®¡ç†å™¨å¤„ç†å¥–åŠ±
      return battleManager.getRewards();
    }
  </script>
</body>
</html>